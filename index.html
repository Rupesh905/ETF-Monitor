<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iShares US Financials ETF (IXG) - Holdings Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #2d3748;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #2d3748;
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .positive {
            color: #48bb78;
        }

        .negative {
            color: #f56565;
        }

        .neutral {
            color: #718096;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .holding-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .holding-item:hover {
            background: #f7fafc;
        }

        .holding-info {
            flex: 1;
        }

        .ticker {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .company-name {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .weight {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-right: 20px;
        }

        .change-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .new-badge {
            background: #c6f6d5;
            color: #22543d;
        }

        .removed-badge {
            background: #fed7d7;
            color: #742a2a;
        }

        .increased-badge {
            background: #bee3f8;
            color: #2c5282;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .last-update {
            text-align: center;
            color: #718096;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .github-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: #2d3748;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .github-link:hover {
            background: #1a202c;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š iShares US Financials ETF (IXG)</h1>
            <p class="subtitle">Real-time Holdings Dashboard & Comparison Tool</p>
            <a href="https://github.com/Rupael005/ETF-Monitor" class="github-link" target="_blank">
                View on GitHub â†’
            </a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Holdings</div>
                <div class="stat-value" id="totalHoldings">--</div>
                <div class="stat-change neutral" id="holdingsChange">Loading...</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">New Holdings</div>
                <div class="stat-value positive" id="newHoldings">--</div>
                <div class="stat-change neutral">Added today</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Removed Holdings</div>
                <div class="stat-value negative" id="removedHoldings">--</div>
                <div class="stat-change neutral">Removed today</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Weight Changes</div>
                <div class="stat-value" id="weightChanges">--</div>
                <div class="stat-change neutral">Significant changes</div>
            </div>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')">All Holdings</button>
                <button class="tab" onclick="switchTab('new')">New Holdings</button>
                <button class="tab" onclick="switchTab('removed')">Removed</button>
                <button class="tab" onclick="switchTab('changes')">Weight Changes</button>
            </div>

            <div id="all-tab" class="tab-content active">
                <div id="allHoldings" class="loading">
                    Loading holdings data from GitHub...
                </div>
            </div>

            <div id="new-tab" class="tab-content">
                <div id="newHoldingsContent" class="loading">
                    Loading new holdings...
                </div>
            </div>

            <div id="removed-tab" class="tab-content">
                <div id="removedHoldingsContent" class="loading">
                    Loading removed holdings...
                </div>
            </div>

            <div id="changes-tab" class="tab-content">
                <div id="changesContent" class="loading">
                    Loading weight changes...
                </div>
            </div>

            <div class="last-update" id="lastUpdate">
                Last updated: --
            </div>
        </div>
    </div>

    <script>
        // GitHub repository information
        const GITHUB_REPO = 'Rupael005/ETF-Monitor';
        const GITHUB_BRANCH = 'main';

        let currentData = null;
        let previousData = null;

        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        async function fetchLatestData() {
            try {
                // Fetch list of files in etf_data folder
                const filesResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_REPO}/contents/etf_data?ref=${GITHUB_BRANCH}`
                );

                if (!filesResponse.ok) {
                    throw new Error('Failed to fetch file list from GitHub');
                }

                const files = await filesResponse.json();
                
                // Find the latest holdings and report files
                const holdingsFiles = files
                    .filter(f => f.name.startsWith('holdings_') && f.name.endsWith('.json'))
                    .sort((a, b) => b.name.localeCompare(a.name));

                if (holdingsFiles.length === 0) {
                    throw new Error('No data files found. Please run the workflow first.');
                }

                // Get the latest file
                const latestFile = holdingsFiles[0];
                const dataResponse = await fetch(latestFile.download_url);
                currentData = await dataResponse.json();

                // Get previous file if exists
                if (holdingsFiles.length > 1) {
                    const prevFile = holdingsFiles[1];
                    const prevResponse = await fetch(prevFile.download_url);
                    previousData = await prevResponse.json();
                }

                displayData();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('allHoldings').innerHTML = `
                    <div class="error">
                        <strong>Error loading data:</strong> ${error.message}<br><br>
                        Make sure you've run the GitHub Action at least once.<br>
                        <a href="https://github.com/${GITHUB_REPO}/actions" target="_blank" style="color: #2c5282;">
                            Run workflow on GitHub â†’
                        </a>
                    </div>
                `;
            }
        }

        function displayData() {
            if (!currentData) return;

            const comparison = compareData();

            // Update stats
            document.getElementById('totalHoldings').textContent = currentData.total_count || 0;
            document.getElementById('newHoldings').textContent = comparison.newHoldings.length;
            document.getElementById('removedHoldings').textContent = comparison.removedHoldings.length;
            document.getElementById('weightChanges').textContent = comparison.weightChanges.length;
            document.getElementById('lastUpdate').textContent = `Last updated: ${currentData.date}`;

            // Update holdings change
            const changeText = previousData 
                ? `${comparison.newHoldings.length > 0 ? '+' + comparison.newHoldings.length : 'No'} new, ${comparison.removedHoldings.length > 0 ? '-' + comparison.removedHoldings.length : '0'} removed`
                : 'First data collection';
            document.getElementById('holdingsChange').textContent = changeText;

            // Display all holdings
            displayAllHoldings();
            displayNewHoldings(comparison.newHoldings);
            displayRemovedHoldings(comparison.removedHoldings);
            displayWeightChanges(comparison.weightChanges);
        }

        function compareData() {
            const newHoldings = [];
            const removedHoldings = [];
            const weightChanges = [];

            if (!previousData) {
                return { newHoldings, removedHoldings, weightChanges };
            }

            const currentTickers = new Map();
            const previousTickers = new Map();

            currentData.holdings.forEach(h => {
                if (h[0]) currentTickers.set(h[0], h);
            });

            previousData.holdings.forEach(h => {
                if (h[0]) previousTickers.set(h[0], h);
            });

            // Find new and removed
            currentTickers.forEach((holding, ticker) => {
                if (!previousTickers.has(ticker)) {
                    newHoldings.push(holding);
                }
            });

            previousTickers.forEach((holding, ticker) => {
                if (!currentTickers.has(ticker)) {
                    removedHoldings.push(holding);
                }
            });

            // Find weight changes
            currentTickers.forEach((holding, ticker) => {
                if (previousTickers.has(ticker)) {
                    const currWeight = parseFloat(String(holding[2]).replace('%', '')) || 0;
                    const prevWeight = parseFloat(String(previousTickers.get(ticker)[2]).replace('%', '')) || 0;
                    
                    if (Math.abs(currWeight - prevWeight) > 0.01) {
                        weightChanges.push({
                            holding,
                            prevWeight,
                            currWeight,
                            change: currWeight - prevWeight
                        });
                    }
                }
            });

            weightChanges.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));

            return { newHoldings, removedHoldings, weightChanges };
        }

        function displayAllHoldings() {
            const container = document.getElementById('allHoldings');
            const holdings = currentData.holdings.slice(0, 50); // Show top 50

            container.innerHTML = holdings.map(h => `
                <div class="holding-item">
                    <div class="holding-info">
                        <div class="ticker">${h[0] || 'N/A'}</div>
                        <div class="company-name">${h[1] || ''}</div>
                    </div>
                    <div class="weight">${h[2] || '0'}%</div>
                </div>
            `).join('') + `<div style="padding: 20px; text-align: center; color: #718096;">
                Showing top 50 holdings
            </div>`;
        }

        function displayNewHoldings(newHoldings) {
            const container = document.getElementById('newHoldingsContent');
            
            if (newHoldings.length === 0) {
                container.innerHTML = '<div class="loading">No new holdings added</div>';
                return;
            }

            container.innerHTML = newHoldings.map(h => `
                <div class="holding-item">
                    <div class="holding-info">
                        <div class="ticker">${h[0] || 'N/A'}</div>
                        <div class="company-name">${h[1] || ''}</div>
                    </div>
                    <span class="change-badge new-badge">NEW</span>
                </div>
            `).join('');
        }

        function displayRemovedHoldings(removedHoldings) {
            const container = document.getElementById('removedHoldingsContent');
            
            if (removedHoldings.length === 0) {
                container.innerHTML = '<div class="loading">No holdings removed</div>';
                return;
            }

            container.innerHTML = removedHoldings.map(h => `
                <div class="holding-item">
                    <div class="holding-info">
                        <div class="ticker">${h[0] || 'N/A'}</div>
                        <div class="company-name">${h[1] || ''}</div>
                    </div>
                    <span class="change-badge removed-badge">REMOVED</span>
                </div>
            `).join('');
        }

        function displayWeightChanges(weightChanges) {
            const container = document.getElementById('changesContent');
            
            if (weightChanges.length === 0) {
                container.innerHTML = '<div class="loading">No significant weight changes</div>';
                return;
            }

            container.innerHTML = weightChanges.map(item => `
                <div class="holding-item">
                    <div class="holding-info">
                        <div class="ticker">${item.holding[0] || 'N/A'}</div>
                        <div class="company-name">${item.holding[1] || ''}</div>
                        <div class="company-name">
                            ${item.prevWeight.toFixed(3)}% â†’ ${item.currWeight.toFixed(3)}%
                        </div>
                    </div>
                    <span class="change-badge increased-badge">
                        ${item.change > 0 ? 'â†‘' : 'â†“'} ${Math.abs(item.change).toFixed(3)}%
                    </span>
                </div>
            `).join('');
        }

        // Load data when page loads
        fetchLatestData();

        // Refresh every 5 minutes
        setInterval(fetchLatestData, 5 * 60 * 1000);
    </script>
</body>
</html>
